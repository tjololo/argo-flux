create-cluster:
	kind create cluster --config install/kind-config.yaml --name flux
	kubectl cluster-info --context kind-flux

deploy-nginx:
	kubectl apply -f install/nginx/deploy.yaml
	kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=360s

install-gitea:
	helm repo add k8s-land https://charts.k8s.land
	helm install gitea k8s-land/gitea -f install/gitea/values.yaml
	kubectl wait --timeout=360s -n default --for=condition=available deployments.apps/gitea-gitea
	kubectl wait --timeout=360s -n default --for=condition=ready pods/gitea-mariadb-0
	./install/gitea/initialize.sh

install-flux:
	kubectl create ns flux
	fluxctl install \
	--git-user=demo \
	--git-email=demo@example.local \
	--git-url=git@gitea-gitea-http.default.svc.cluster.local:3000/demo/argo-flux \
	--git-path=flux/apps \
	--namespace=flux | kubectl apply -f -
	##TODO: add wait command

print-credentials:
	@echo "Demo cluster is ready. Gitea url: http://gitea.127.0.0.1.xip.io"
	@echo "Gitea login. Username: demo Passord: Password#1"

create-cluster: create-cluster deploy-nginx install-gitea install-flux print-credentials

## Cleanup
delete-cluster:
	kind delete cluster --name flux